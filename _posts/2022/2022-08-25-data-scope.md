---
layout: post
title: "数据权限控制"
date: 2022-08-25 10:10:00 +0800
categories: tech
---
一般项目中的某个角色在增删改查数据时，都会对访问数据范围做一定的限制。比如A部门的成员只能查阅A部门的数据。

当然我们可以简单的实现，将业务表关联用户部门关系表，通过in语句过滤用户所在部门数据，得以实现功能。但我们这样将权限控制代码硬编码的话。那么后续可能出现的其他业务场景，比如或者管理员可以查阅多个部门的数据这样的情况，就需要重新修改所有涉及到的业务代码了。

这边参考的若依开源框架中数据权限控制代码实现进行讲解。其中的数据权限是按照部门进行划分，然后和角色进行绑定。在编写代码的时候只需要添加@DataScope注解和sql映射xml文件中添加${dataScope}就可以实现对权限的控制。

首先是设置了自定义注解@DataScope，通过AOP注解对添加有@DataScope的方法进行切面处理。

![](https://raw.githubusercontent.com/xiejinjie/xiejinjie.github.io/gh-pages/assets/img/20230316091332.png)

然后再根据用户角色绑定的数据权限，生成对应的数据过滤sql，将生成的sql存储在请求对象的基类中，在sql映射时可以通过${dataScope}在原有sql进行拼接，这样就完成了权限控制功能。可以设置不同类型的数据权限，编写对应过滤sql生成逻辑代码，就可以灵活的配置角色的权限了。在实际业务场景中，可以参考设计不同的数据权限方案。
